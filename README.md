# 톰캣 구현하기

## 세션 & 쿠키

- 서버는 구동되는 시점에 세션 저장소를 생성하고, 모든 요청에 대해 특정한 세션을 할당하며 이를 관리한다.
    - 요청 메시지의 Cookie 헤더에 유효한 JSESSIONID 값이 없는 경우, 새로운 세션을 생성하여 요청에 할당하고, 응답 메시지있 Set-Cookie 헤더에 해당 세션 ID 값을 할당한다.
    - 브라우저에서는 응답 메시지의 Set-Cookie 헤더를 통해 JSESSIONID 키에 해당되는 쿠키를 저장하게 되며, 이후 모든 요청들에서 Cookie 헤더에 포함시킨다.
    - 요청 메시지의 Cookie 헤더에 JSESSIONID 값이 존재하고, 서버에서 관리 중인 유효한 세션에 대응되는 경우 해당 요청에 대해 해당 세션을 그대로 할당한다.
    - 사용자가 로그인에 성공한 경우, 해당 요청에 할당된 세션에 해당 사용자 정보를 추가한다.

## 쓰레드풀

- 서버는 클라이언트의 요청을 쓰레드풀의 쓰레드에 할당하여 처리하도록 한다.
- 여유가 있는 쓰레드가 존재하는 경우 새로운 쓰레드를 생성하지 않고 그대로 재사용한다.
- `corePoolSize=10`
    - 쓰레드풀에 기본적으로 10개의 쓰레드를 생성하여 유지한다.
    - 쓰레드풀 생성 초기에는 0개의 쓰레드가 존재하지만 요청이 들어옴에 따라 쓰레드를 하나씩 생성한다.
- `maxQueueSize=20`
    - 동시에 처리해야 하는 요청이 10개를 초과한 경우, 최대 20개의 요청을 쓰레드풀 내부의 큐에 대기시키고 향후 여유가 생긴 쓰레드에 할당한다.
- `maximumPoolSize=1000`
    - 쓰레드풀 내부의 큐가 꽉 찬 상태에서 요청이 들어오는 경우, 쓰레드를 추가적으로 생성하여 큐의 작업을 하나씩 할당한다.
    - 쓰레드풀에 존재할 수 있는 쓰레드의 최대 개수는 1000개다.
    - 1000개의 쓰레드가 생성된 상태에서 큐가 꽉 찼는데 요청이 추가적으로 들어오면 예외가 발생한다.
- `keepAliveTime=60000, unit=TimeUnit.MILLISECONDS`
    - 쓰레드의 개수가 10개를 초과한 경우, 60초 이상 아무런 작업을 수행하지 않는 쓰레드는 순차적으로 제거된다.

## 세부 비즈니스 로직

- `GET /` 혹은 `GET /index` 요청시 index.html 응답

- `GET /login` 요청시, 해당 요청에 할당된 세션에 사용자 정보가 존재하는지에 따라 index.html 혹은 login.html 응답
    - 해당 요청에 세션에 사용자 정보가 존재하지 않는 경우, 로그인을 할 수 있도록 200를 응답하며 /login.html 페이지를 응답한다.
    - 해당 요청에 세션에 사용자 정보가 존재하는 경우, 로그인된 사용자로 간주하여 302를 응답하여 Location 헤더를 통해 /index.html 페이지로 이동시킨다.
- `POST /login` 요청시 form에 입력된 값에 따라 302 혹은 401을 응답한다.
    - `account`와 `password` 정보에 대응되는 사용자가 서버에 존재하는 경우 302를 응답하여 Location 헤더를 통해 /index.html 페이지로 이동시킨다.
    - 잘못된 사용자 정보를 입력한 경우, 401을 응답하며 /401.html 페이지를 응답한다.

- `GET /register` 요청시 register.html 응답
- `POST /register` 요청시 form에 입력된 값에 따라 302 혹은 400을 응답한다.
    - 새로운 `account` 정보로 사용자 생성에 성공한 경우, 302를 응답하여 Location 헤더를 통해 /index.html 페이지로 이동시킨다.
    - 이미 `account`에 대응되는 사용자가 서버에 존재하는 경우 사용자 생성에 실패하며, 400을 응답하며 /400.html 페이지를 응답한다.

- 등록되지 않은 URI에 대한 GET 요청시, 해당 URI에 대응되는 정적 자원을 응답한다.

- 요청 처리 과정에서 문제가 발생한 경우, 응답 메시지에 그에 대응되는 상태코드를 포함시킨다.
  - 응답 메시지에 관련 상태코드 추가(e.g., 404 NOT FOUND)
  - 그에 대응되는 페이지를 보여준다.
  - 존재하지 않는 자원을 요청한 경우, 404.html 응답
  - 예상하지 못한 문제인 경우, 500.html 응답
  - 상태코드가 500이 아니더라도, 대응되는 html 파일이 없는 경우 500.html 응답

## 기타

- 요청에 parameter 값이 포함되면 파싱하여 처리한다.
  - URI에 query string이 포함되면 파싱하여 처리한다.
  - Content-Type 헤더 값에 따라 request body에 포함된 파라미터 값의 파싱 여부를 결정한다.
- 요청한 자원의 확장자에 따라 Content-Type 설정하여 응답한다. (text/html, text/css, text/javascript, etc)
